{% extends "home/base.html" %}
{% load static %}
{% block extra_css %}
    <link type="text/css"
          rel="stylesheet"
          href="{% static "css/courses.css" %}" />
    <style>
        .formset-row {
            background-color: #f8f9fa;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }
        .formset-row.to-delete {
            opacity: 0.5;
            text-decoration: line-through;
        }
        .formset-header {
            display: grid;
            grid-template-columns: 2fr 3fr 1fr auto;
            gap: 15px;
            align-items: start;
        }
        .form-field {
            display: flex;
            flex-direction: column;
        }
        .form-field label {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        .delete-checkbox {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 25px;
        }
        .empty-form-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #dee2e6;
        }
        .empty-form-section h3 {
            margin-bottom: 20px;
        }
        input[type="datetime-local"] {
            padding: 0.375rem 0.75rem;
        }
    </style>
{% endblock extra_css %}
{% block title %}
    Manage Meetings - {{ course.name }} - Athemath
{% endblock title %}
{% block content %}
    <div id="content">
        <div class="course">
            <h1>Manage Meetings</h1>
            <p class="text-muted">
                <a href="{% url 'courses:course_detail' pk=course.pk %}">{{ course.name }}</a> - {{ course.semester }}
            </p>
            <p class="text-info">Edit existing meetings, add new ones, or mark meetings for deletion all in one form.</p>
            <form method="post">
                {% csrf_token %}
                {{ formset.management_form }}
                {% if formset.non_form_errors %}<div class="alert alert-danger">{{ formset.non_form_errors }}</div>{% endif %}
                {% if formset.forms %}
                    {% for form in formset %}
                        {# Show "Existing Meetings" header before first existing meeting #}
                        {% if form.instance.pk and forloop.first %}<h3>Existing Meetings</h3>{% endif %}
                        {# Show "Add New Meetings" header before first empty form #}
                        {% if not form.instance.pk and forloop.counter0 == formset.queryset.count %}
                            <div class="empty-form-section">
                                <h3>Add New Meetings</h3>
                            {% endif %}
                            <div class="formset-row {% if form.instance.pk %}existing-meeting{% endif %}"
                                 data-form-index="{{ forloop.counter0 }}">
                                {% if form.non_field_errors %}<div class="alert alert-danger">{{ form.non_field_errors }}</div>{% endif %}
                                <div class="formset-header">
                                    <div class="form-field">
                                        {{ form.start_time.label_tag }}
                                        {{ form.start_time }}
                                        {% if form.start_time.errors %}<small class="text-danger">{{ form.start_time.errors }}</small>{% endif %}
                                    </div>
                                    <div class="form-field">
                                        {{ form.title.label_tag }}
                                        {{ form.title }}
                                        {% if form.title.errors %}<small class="text-danger">{{ form.title.errors }}</small>{% endif %}
                                    </div>
                                    {% if form.instance.pk %}
                                        <div class="form-field">
                                            <label>Reminder Sent</label>
                                            <div>
                                                {% if form.instance.reminder_sent %}
                                                    <span class="badge bg-success">Yes</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">No</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    {% else %}
                                        <div class="form-field">{# Placeholder for grid alignment #}</div>
                                    {% endif %}
                                    <div class="delete-checkbox">
                                        {{ form.DELETE }}
                                        <label for="{{ form.DELETE.id_for_label }}">Delete?</label>
                                    </div>
                                </div>
                                {{ form.id }}
                            </div>
                        {% endfor %}
                        {# Close the empty-form-section div if there were any empty forms #}
                        {% if formset.queryset.count < formset.total_form_count %}</div>{% endif %}
                {% else %}
                    <p class="text-muted">No meetings configured yet. Use the forms below to add new meetings.</p>
                {% endif %}
                <div class="mt-4">
                    <button type="submit" class="btn btn-primary">Save All Changes</button>
                    <a href="{% url 'courses:course_detail' pk=course.pk %}"
                       class="btn btn-secondary">Cancel</a>
                </div>
            </form>
        </div>
    </div>
    <script>
        // Add visual feedback when delete checkbox is checked
        document.addEventListener('DOMContentLoaded', function() {
            const deleteCheckboxes = document.querySelectorAll('input[name$="-DELETE"]');
            deleteCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const row = this.closest('.formset-row');
                    if (this.checked) {
                        row.classList.add('to-delete');
                    } else {
                        row.classList.remove('to-delete');
                    }
                });
                // Set initial state if already checked
                if (checkbox.checked) {
                    checkbox.closest('.formset-row').classList.add('to-delete');
                }
            });
        });
    </script>
{% endblock content %}
